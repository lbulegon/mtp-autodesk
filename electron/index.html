<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MotoPro AutoDesk</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- TELA DE LOGIN (inicialmente visível) -->
  <div id="login-overlay" class="login-overlay">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo">🏢</div>
          <div class="login-title">MotoPro</div>
          <div class="login-subtitle">Sistema de Gestão de Vagas</div>
        </div>
        
        <form id="loginForm" class="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required placeholder="seu@email.com">
          </div>
          
          <div class="form-group">
            <label for="password">Senha</label>
            <input type="password" id="password" name="password" required placeholder="••••••••">
          </div>
          
          <button type="submit" id="loginBtn" class="login-btn">
            <span id="loginBtnText">🔐 Entrar</span>
          </button>
        </form>
        
        <div id="loginStatus" class="login-status"></div>
        
        <div class="login-credentials">
          <div>Credenciais de teste:</div>
          <div><strong>Email:</strong> lbulegon@gmail.com</div>
          <div><strong>Senha:</strong> Gabi#0201</div>
        </div>
      </div>
    </div>
  </div>

  <!-- APLICAÇÃO PRINCIPAL (inicialmente oculta) -->
  <div id="main-app" class="app" style="display: none;">
    <!-- Topbar -->
    <header class="topbar">
    <div class="store-badge">
      <div class="store-icon">🏍</div>
      <div>
        <div class="store-name">MotoPro Central</div>
        <div class="store-open">Aberto</div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><div class="kpi-label">Hoje</div><div class="kpi-value">125</div></div>
      <div class="kpi"><div class="kpi-label">Mês</div><div class="kpi-value">3.452</div></div>
    </div>
    <div class="top-right">
      <button class="icon-btn has-tip" data-tip="Ajuda">❓</button>
      <button class="icon-btn has-tip" data-tip="Notificações">🔔</button>
      <button class="icon-btn has-tip" data-tip="Configurações">⚙️</button>
      <div class="avatar has-tip" data-tip="Perfil">MP</div>
    </div>
  </header>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button class="side-icon has-tip active" data-tip="Pedidos" id="btn-orders">📦</button>
      <button class="side-icon has-tip" data-tip="Vagas" id="btn-vagas">📋</button>
      <button class="side-icon has-tip" data-tip="Alocações" id="btn-alocacoes">👥</button>
      <button class="side-icon has-tip" data-tip="Admin Vagas" id="btn-admin-vagas">🗓️</button>
    </aside>

    <!-- Conteúdo em 2 colunas -->
    <main class="content">
      <!-- COLUNA ESQUERDA -->
      <section class="left">
        <!-- VIEW: Pedidos -->
        <div id="left-orders" class="left-view">
          <div class="auto-accept">
            <span>Aceite automático de pedidos</span>
            <button id="btnAuto" class="btn-auto off has-tip" data-tip="Aceite automático desativado">OFF</button>
          </div>

          <div class="search-row">
            <div class="search">
              <span class="search-ico">🔎</span>
              <input id="search" type="text" placeholder="Buscar pedido" />
            </div>
            <button class="btn btn-outline has-tip" data-tip="Filtrar pedidos">Filtros</button>
          </div>

          <section class="section section--scroll section--pendentes">
            <div class="section-title">Pedidos Pendentes <span class="badge" id="count-pendentes">8</span></div>
            <div class="list" id="list-pendentes"></div>
          </section>

          <section class="section section--scroll section--entrega">
            <div class="section-title">Em entrega <span class="badge" id="count-entrega">2</span></div>
            <div class="list" id="list-entrega"></div>
          </section>
        </div>



        <!-- VIEW: Vagas (lista simples) -->
        <div id="left-vagas" class="left-view hidden">
          <h2 class="section-title">Gestão de Vagas</h2>
          <div class="list" id="list-vagas" style="padding:12px;"></div>
        </div>

        <!-- VIEW: Alocações (motoboys alocados) -->
        <div id="left-alocacoes" class="left-view hidden">
          <h2 class="section-title">Alocações Ativas</h2>
          <div class="list" id="alocacoes-container" style="padding:12px;"></div>
        </div>

        <!-- NOVA VIEW: Admin Vagas (calendário) -->
        <div id="left-admin-vagas" class="left-view hidden">
          <div class="auto-accept">
            <span>Calendário de Vagas</span>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="prevMonthAdmin" class="btn">◀</button>
              <strong id="monthLabelAdmin">Mês AAAA</strong>
              <button id="nextMonthAdmin" class="btn">▶</button>
            </div>
          </div>

          <!-- Interface Gerar Vagas Fixas -->
          <div class="search-row" style="margin-bottom: 16px; flex-direction: column; gap: 12px;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <span style="font-weight: 600; color: #333;">📋 Gerar Vagas Fixas</span>
            </div>
            
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-size: 12px; color: #666; min-width: 80px;">Data:</label>
              <input type="date" id="dataInicioVagas" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
            </div>
            
            <button id="btnGerarVagasFixas" class="btn btn-primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="gerarVagasFixas();">
              <span>🚀</span>
              <span>Gerar Vagas para o Dia</span>
            </button>
          </div>

          <div class="calendar">
            <div class="cal-head">
              <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
            </div>
            <div id="calGridAdmin" class="cal-grid"><!-- dias via JS --></div>
          </div>
        </div>
      </section>

      <!-- COLUNA DIREITA -->
      <section class="right">
        <div class="detail empty" id="detail">Selecione um item para ver detalhes</div>
      </section>
    </main>
  </div> <!-- Fechamento da div main-app -->

  <!-- Scripts de configuração -->
  <script src="config.js"></script>
  <!-- <script src="autoaceite.js"></script> -->

  <!-- Sistema de autenticação global -->
  <script src="authManager.js"></script>

  <!-- Carrega o módulo de integração de vagas ANTES dos outros scripts -->
  <script src="vagasIntegration.js"></script>

  <!-- Sistema de login da aplicação -->
  <script>
    // ====== SISTEMA DE LOGIN DA APLICAÇÃO ======
    class AppLoginManager {
      constructor() {
        this.loginOverlay = document.getElementById('login-overlay');
        this.mainApp = document.getElementById('main-app');
        this.loginForm = document.getElementById('loginForm');
        this.emailInput = document.getElementById('email');
        this.passwordInput = document.getElementById('password');
        this.loginBtn = document.getElementById('loginBtn');
        this.loginBtnText = document.getElementById('loginBtnText');
        this.loginStatus = document.getElementById('loginStatus');
        
        this.init();
      }
      
      init() {
        // Preencher credenciais de teste
        if (this.emailInput && this.passwordInput) {
          this.emailInput.value = 'lbulegon@gmail.com';
          this.passwordInput.value = 'Gabi#0201';
        }
        
        // Vincular eventos
        if (this.loginForm) {
          this.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
          });
        }
        
        // Verificar se já está autenticado
        this.checkAuthStatus();
      }
      
      async checkAuthStatus() {
        // Aguardar um pouco para garantir que o AuthManager foi carregado
        setTimeout(() => {
          if (window.authManager && window.authManager.isAuthenticated) {
            console.log('✅ Usuário já autenticado, mostrando aplicação...');
            this.showApp();
          } else {
            console.log('🔐 Usuário não autenticado, mostrando tela de login...');
            this.showLogin();
          }
        }, 500);
      }
      
      async handleLogin() {
        if (!this.emailInput || !this.passwordInput || !this.loginBtn || !this.loginStatus) return;
        
        const email = this.emailInput.value.trim();
        const password = this.passwordInput.value;
        
        if (!email || !password) {
          this.showStatus('Por favor, preencha todos os campos', 'error');
          return;
        }
        
        // Desabilitar botão e mostrar loading
        this.loginBtn.disabled = true;
        this.loginBtnText.textContent = '⏳ Entrando...';
        this.showStatus('', '');
        
        try {
          console.log('🔐 Tentando login com:', email);
          
          // Usar o AuthManager para fazer login
          const result = await window.authManager.login(email, password);
          
          if (result.success) {
            this.showStatus('✅ Login realizado com sucesso!', 'success');
            
            // Aguardar um pouco para mostrar a mensagem de sucesso
            setTimeout(() => {
              this.showApp();
            }, 1000);
          } else {
            this.showStatus('❌ Falha no login', 'error');
          }
        } catch (error) {
          console.error('❌ Erro no login:', error);
          this.showStatus(`❌ Erro: ${error.message}`, 'error');
        } finally {
          // Reabilitar botão
          this.loginBtn.disabled = false;
          this.loginBtnText.textContent = '🔐 Entrar';
        }
      }
      
      showStatus(message, type) {
        if (!this.loginStatus) return;
        
        if (!message) {
          this.loginStatus.style.display = 'none';
          this.loginStatus.className = 'login-status';
          return;
        }
        
        this.loginStatus.style.display = 'block';
        this.loginStatus.textContent = message;
        this.loginStatus.className = `login-status ${type}`;
      }
      
      showLogin() {
        if (this.loginOverlay) this.loginOverlay.style.display = 'flex';
        if (this.mainApp) this.mainApp.style.display = 'none';
      }
      
      showApp() {
        if (this.loginOverlay) this.loginOverlay.style.display = 'none';
        if (this.mainApp) this.mainApp.style.display = 'block';
        
        // Inicializar a aplicação
        this.initApp();
      }
      
      initApp() {
        console.log('🚀 Inicializando aplicação...');
        
        // Renderizar listas iniciais
        if (typeof renderOrdersLists === 'function') {
          renderOrdersLists();
        }
        
        // Inicializar integração de vagas
        if (window.vagasIntegration && typeof window.vagasIntegration.init === 'function') {
          window.vagasIntegration.init();
        }
        
        console.log('✅ Aplicação inicializada');
      }
    }
    
    // Inicializar o sistema de login quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      new AppLoginManager();
    });
  </script>

  <script>
    // --------- Dados de exemplo de entregadores ---------
    const ridersData = [
      { id: 11, nome: "João Silva",  foto: "", status: "Ativo",   entregasTurno: 5, placa: "ABC-1234", telefone: "(11) 99999-1111", rating: 4.8 },
      { id: 22, nome: "Maria Santos",foto: "", status: "Ocupado", entregasTurno: 3, placa: "XYZ-5678", telefone: "(11) 98888-2222", rating: 4.6 },
      { id: 33, nome: "Pedro Lima",  foto: "", status: "Inativo", entregasTurno: 0, placa: "MTP-2025", telefone: "(11) 97777-3333", rating: 4.1 },
      { id: 44, nome: "Carla Souza", foto: "https://randomuser.me/api/portraits/women/65.jpg", status: "Ativo", entregasTurno: 7, placa: "JKL-0001", telefone: "(11) 96666-4444", rating: 4.9 },
    ];

    // --------- Utils: iniciais + cor fixa por nome ---------
    function initials(name){ return (name||"").split(/\s+/).slice(0,2).map(p=>p[0]).join("").toUpperCase(); }
    function colorFrom(name){
      const colors=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#14b8a6","#f97316","#06b6d4"];
      let sum=0; for(const c of name) sum=(sum+c.charCodeAt(0))%997; return colors[sum%colors.length];
    }

    // --------- Render lista de entregadores (cards) ---------
    function renderRidersList(){
      const list=document.getElementById("riders-list");
      list.innerHTML=ridersData.map(r=>{
        const hasPhoto=!!r.foto;
        const avatar=hasPhoto
          ? `<img src="${r.foto}" alt="${r.nome}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;">`
          : `<div class="avatar-circle" style="background:${colorFrom(r.nome)}">${initials(r.nome)}</div>`;
        const statusClass=r.status==="Ativo"?"badge-online":(r.status==="Ocupado"?"chip":"badge-offline");
        return `
          <div class="rider-card has-tip" data-tip="Ver detalhes" data-id="${r.id}" style="cursor:pointer">
            ${avatar}
            <div class="rider-info" style="flex:1">
              <h3 style="margin:0;font-size:15px">${r.nome}</h3>
              <div class="rider-meta">Placa ${r.placa} • Entregas no turno: <strong>${r.entregasTurno}</strong></div>
            </div>
            <div class="${statusClass}">${r.status}</div>
          </div>`;
      }).join("");

      list.querySelectorAll(".rider-card").forEach(card=>{
        card.addEventListener("click",()=>{
          const id=Number(card.getAttribute("data-id"));
          const rider=ridersData.find(r=>r.id===id);
          if(rider) renderRiderDetail(rider);
        });
      });
    }

    // --------- Render detalhes (motoboy) ---------
    function renderRiderDetail(r){
      const box=document.getElementById("detail");
      box.classList.remove("empty");
      const hasPhoto=!!r.foto;
      const hero=hasPhoto?`<img src="${r.foto}" alt="${r.nome}">`:`<div class="rider-hero" style="background:${colorFrom(r.nome)}">${initials(r.nome)}</div>`;
      box.innerHTML=`
        <div class="rider-header">
          ${hasPhoto?`<div class="rider-hero">${hero}</div>`:hero}
          <div class="rider-title">
            <div class="rider-name">${r.nome}</div>
            <div class="rider-badges">
              <span class="${r.status==='Ativo'?'badge-online':(r.status==='Ocupado'?'chip':'badge-offline')}">${r.status}</span>
              <span class="badge-ghost">Placa: ${r.placa}</span>
              <span class="badge-ghost">Tel: ${r.telefone}</span>
            </div>
          </div>
        </div>
        <div class="actions-bar">
          <button class="btn-outline">Abrir no painel web</button>
          <button class="btn-primary">Chamar para entrega</button>
          <button class="btn btn-soft">Enviar mensagem</button>
        </div>
        <div class="detail-section">
          <div class="stat-grid">
            <div class="stat"><div class="k">Entregas (turno)</div><div class="v">${r.entregasTurno}</div></div>
            <div class="stat"><div class="k">Avaliação</div><div class="v">⭐ ${r.rating.toFixed(1)}</div></div>
            <div class="stat"><div class="k">Pontualidade</div><div class="v">96%</div></div>
            <div class="stat"><div class="k">Taxa aceite</div><div class="v">88%</div></div>
          </div>
          <div class="info-cards">
            <div class="info-card">
              <div class="label">Documento</div><div class="value">***.***.***-**</div>
              <div class="label" style="margin-top:6px">CNH</div><div class="value">AB • Válida</div>
            </div>
            <div class="info-card">
              <div class="label">Veículo</div><div class="value">Moto • ${r.placa}</div>
              <div class="label" style="margin-top:6px">Seguro</div><div class="value">OK</div>
            </div>
          </div>
          <div class="timeline">
            <div style="font-weight:800; margin-bottom:6px;">Últimos eventos</div>
            <div class="item"><div class="dot"></div><div><div>Finalizou entrega #4321</div><div class="when">há 6 min</div></div></div>
            <div class="item"><div class="dot"></div><div><div>Retirou pedido #4321</div><div class="when">há 18 min</div></div></div>
            <div class="item"><div class="dot"></div><div><div>Entrou no turno</div><div class="when">há 1h 02min</div></div></div>
          </div>
          <div class="footer-actions" style="justify-content:flex-end">
            <button class="btn-danger">Bloquear</button>
            <button class="btn-outline">Remover do turno</button>
          </div>
        </div>`;
    }

    // ========= DADOS EXEMPLO =========
    const ordersDataPendentes = [
      { id:1001, cliente:"Maria Silva",  status:"Em preparo", prazo:"12:30", pagamento:"PIX",     taxaEntrega:7.90, subtotal:52.00, desconto:5.00,
        endereco:"Rua das Flores, 123 • Bela Vista", obs:"Sem cebola",
        itens:[ {nome:"Burger Clássico",qtd:1,preco:28.00}, {nome:"Batata média",qtd:1,preco:12.00}, {nome:"Refrigerante",qtd:1,preco:12.00} ] },
      { id:1002, cliente:"João Pereira", status:"Em preparo", prazo:"12:34", pagamento:"Crédito", taxaEntrega:6.90, subtotal:39.90, desconto:0.00,
        endereco:"Av. Paulista, 555 • Consolação", obs:"",
        itens:[ {nome:"Wrap Frango",qtd:1,preco:22.90}, {nome:"Suco Laranja",qtd:1,preco:17.00} ] },
    ];
    const ordersDataEntrega = [
      { id:999, cliente:"Carlos Lima",  status:"A caminho", prazo:"13:05", pagamento:"Dinheiro", taxaEntrega:8.50, subtotal:61.00, desconto:0.00,
        endereco:"R. Itapura, 77 • Moema", obs:"Troco para 100", itens:[ {nome:"Combo Família",qtd:1,preco:61.00} ] },
      { id:998, cliente:"Beatriz Costa",status:"A caminho", prazo:"13:12", pagamento:"Débito",  taxaEntrega:7.50, subtotal:42.00, desconto:2.00,
        endereco:"R. Vergueiro, 2210 • Vila Mariana", obs:"", itens:[ {nome:"Salada Caesar",qtd:1,preco:24.00}, {nome:"Água 500ml",qtd:2,preco:9.00}, {nome:"Molho extra",qtd:1,preco:9.00} ] },
    ];
    const vagasData = [
      { id:1, titulo:"Turno Almoço", janela:"11:00–15:00", capacidade:6, ocupadas:4, local:"Zona Sul",  requisitos:["CNH A válida","Moto própria","Seguro OK"] },
      { id:2, titulo:"Turno Jantar", janela:"18:00–22:00", capacidade:8, ocupadas:7, local:"Zona Leste", requisitos:["CNH A válida","Experiência > 6 meses"] },
    ];

    // ========= HELPERS =========
    function money(v){ return v.toLocaleString("pt-BR",{style:"currency", currency:"BRL"}); }

    // ========= RENDER LISTAS =========
    function renderOrdersLists(){
      const pend=document.getElementById("list-pendentes");
      const entr=document.getElementById("list-entrega");
      const b1=document.getElementById("count-pendentes");
      const b2=document.getElementById("count-entrega");
      b1.textContent=ordersDataPendentes.length;
      b2.textContent=ordersDataEntrega.length;

      pend.innerHTML=ordersDataPendentes.map(o=>`
        <div class="card order-card" data-oid="${o.id}" style="cursor:pointer">
          <div class="row-top"><span class="order-id">#${o.id}</span><span class="order-name">${o.cliente}</span></div>
          <div class="badge-status badge-preparo"><span class="dot"></span> ${o.status}</div>
        </div>`).join("");

      entr.innerHTML=ordersDataEntrega.map(o=>`
        <div class="card order-card" data-oid="${o.id}" style="cursor:pointer">
          <div class="row-top"><span class="order-id">#${o.id}</span><span class="order-name">${o.cliente}</span></div>
          <div class="badge-status badge-entrega"><span class="dot"></span> ${o.status}</div>
        </div>`).join("");

      document.querySelectorAll(".order-card").forEach(el=>{
        el.addEventListener("click",()=>{
          const id=Number(el.getAttribute("data-oid"));
          const o=ordersDataPendentes.find(x=>x.id===id)||ordersDataEntrega.find(x=>x.id===id);
          if(o) renderOrderDetail(o);
        });
      });
    }

    function renderVagasList(){
      // Sempre usar a integração de vagas
      if (typeof window.renderVagasInSidebar === 'function') {
        window.renderVagasInSidebar();
      } else {
        console.error('❌ Módulo de integração de vagas não carregado');
        const box = document.getElementById("list-vagas");
        box.innerHTML = `
          <div style="color: #ef4444; text-align: center; padding: 20px;">
            <div>❌</div>
            <div>Erro: Módulo de vagas não carregado</div>
            <div style="margin-top: 10px;"><button class="btn btn-outline" onclick="location.reload()">Recarregar</button></div>
          </div>
        `;
      }
    }

    // ========= DETALHES (lado direito) =========
    function renderOrderDetail(o){
      const box=document.getElementById("detail");
      box.classList.remove("empty");
      const total=o.subtotal+o.taxaEntrega-(o.desconto||0);
      const badgeClass=(o.status==="A caminho")?"badge-entrega":"badge-preparo";
      box.innerHTML=`
        <div class="hdr">
          <div class="title"><strong>Pedido #${o.id}</strong> • ${o.cliente}</div>
          <div class="meta">
            <span class="pill"><strong>Status:</strong> ${o.status}</span>
            <span class="pill"><strong>Pagamento:</strong> ${o.pagamento}</span>
            <span class="pill"><strong>Prazo:</strong> ${o.prazo}</span>
          </div>
        </div>
        <div class="block">
          <div class="addr"><span>📍</span> <div>${o.endereco}</div></div>
          ${o.obs?`<div class="chips" style="margin-top:8px"><span class="chip">Obs: ${o.obs}</span></div>`:""}
        </div>
        <div class="block items">
          ${o.itens.map(it=>`<div class="item"><div>${it.qtd}× ${it.nome}</div><div>${money(it.preco)}</div></div>`).join("")}
          <div class="item"><div>Subtotal</div><div>${money(o.subtotal)}</div></div>
          <div class="item"><div>Taxa de entrega</div><div>${money(o.taxaEntrega)}</div></div>
          ${o.desconto?`<div class="item"><div>Desconto</div><div>- ${money(o.desconto)}</div></div>`:""}
          <div class="item" style="font-weight:700;border-top:1px dashed #ddd"><div>Total</div><div class="price">${money(total)}</div></div>
        </div>
        <div class="footer-actions">
          <div class="badge-status ${badgeClass}"><span class="dot"></span> ${o.status}</div>
          <div style="flex:1"></div>
          <button class="btn-outline">Imprimir</button>
          <button class="btn-primary">Atribuir entregador</button>
        </div>`;
    }

    function renderVagaDetail(v){
      // Usar a função de detalhes da integração se disponível
      if (typeof window.viewVagaDetails === 'function') {
        window.viewVagaDetails(v.id);
      } else {
        // Fallback para o formato antigo
        const box=document.getElementById("detail");
        box.classList.remove("empty");
        const restante=Math.max(v.capacidade - v.ocupadas,0);
        const livreTxt=restante>0?`${restante} vagas abertas`:"Lotado";
        box.innerHTML=`
          <div class="hdr">
            <div class="title"><strong>${v.titulo}</strong> • ${v.janela}</div>
            <div class="meta">
              <span class="pill"><strong>Local:</strong> ${v.local}</span>
              <span class="pill"><strong>Capacidade:</strong> ${v.capacidade}</span>
              <span class="pill"><strong>Ocupadas:</strong> ${v.ocupadas}</span>
              <span class="pill"><strong>Status:</strong> ${livreTxt}</span>
            </div>
          </div>
          <div class="block">
            <div style="font-weight:700;margin-bottom:8px">Requisitos</div>
            <div class="chips">${v.requisitos.map(r=>`<span class="chip">${r}</span>`).join("")}</div>
          </div>
          <div class="block">
            <div style="font-weight:700;margin-bottom:8px">Candidatos recentes</div>
            <div class="rider-card">
              <div class="thumb" style="display:flex;align-items:center;justify-content:center">👤</div>
              <div style="flex:1;margin-left:10px"><div class="rider-id">Felipe Andrade</div><div class="rider-meta">CNH A • Moto OK • Nota 4.7</div></div>
              <button class="btn-outline">Ver perfil</button>
            </div>
            <div class="rider-card" style="margin-top:8px">
              <div class="thumb" style="display:flex;align-items:center;justify-content:center">👤</div>
              <div style="flex:1;margin-left:10px"><div class="rider-id">Aline Sousa</div><div class="rider-meta">CNH A • Experiência 1 ano • Nota 4.5</div></div>
              <button class="btn-outline">Ver perfil</button>
            </div>
          </div>
          <div class="footer-actions">
            <button class="btn-danger">Encerrar vaga</button>
            <button class="btn-primary">Adicionar entregador</button>
          </div>`;
      }
    }

    // ========= INICIALIZAÇÃO =========
    document.addEventListener("DOMContentLoaded",()=>{
      renderOrdersLists();
      renderVagasList();
    });
  </script>

  <!-- Carrega o módulo Admin Vagas de arquivo externo -->
  <script src="adminvagas.js"></script>
  
  <!-- Carrega o módulo de Alocações de arquivo externo -->
  <script src="alocacoesIntegration.js"></script>

  <!-- Função Global para Gerar Vagas Fixas -->
  <script>
    // Função global para gerar vagas fixas
    async function gerarVagasFixas() {
      console.log('🚀 Função gerarVagasFixas chamada!');
      
      const dataInicioInput = document.getElementById("dataInicioVagas");
      if (!dataInicioInput) {
        alert('❌ Campo de data não encontrado!');
        return;
      }

      const dataInicio = dataInicioInput.value;
      if (!dataInicio) {
        alert('❌ Por favor, selecione uma data!');
        dataInicioInput.focus();
        return;
      }

      // Confirmar ação
      const confirmar = confirm(`📋 Deseja gerar vagas fixas para o dia ${dataInicio}?`);
      if (!confirmar) {
        return;
      }

      try {
        // Verificar se está autenticado
        if (!window.authManager || !window.authManager.isAuthenticated) {
          alert('❌ Usuário não autenticado - faça login primeiro');
          return;
        }

        // Usar estabelecimento ID fixo (pode ser configurado via variável de ambiente)
        const estabelecimentoId = "11"; // Valor padrão, pode ser alterado

        // Preparar payload
        const payload = {
          estabelecimento_id: parseInt(estabelecimentoId),
          data_inicio: dataInicio,
          dias: 1
        };

        console.log('📋 Enviando payload:', payload);

        // Chamar o endpoint
        const response = await window.authManager.authenticatedRequest('/motoboy-vaga/gerar-vagas-fixas/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('✅ Resposta da API:', result);
          console.log('📋 Status da resposta:', response.status);
          console.log('📋 Headers da resposta:', response.headers);
          
          // Determinar quantas vagas foram criadas - lógica melhorada
          let totalVagas = 0;
          let vagasCriadas = [];
          
          // Verificar diferentes possíveis estruturas da resposta
          if (result.vagas_criadas && Array.isArray(result.vagas_criadas)) {
            totalVagas = result.vagas_criadas.length;
            vagasCriadas = result.vagas_criadas;
          } else if (result.vagas_criadas_total !== undefined) {
            totalVagas = result.vagas_criadas_total;
          } else if (result.total_vagas_criadas !== undefined) {
            totalVagas = result.total_vagas_criadas;
          } else if (result.vagas && Array.isArray(result.vagas)) {
            totalVagas = result.vagas.length;
            vagasCriadas = result.vagas;
          } else if (result.count !== undefined) {
            totalVagas = result.count;
          } else if (result.mensagem && result.mensagem.includes('sucesso')) {
            // Se a mensagem indica sucesso, assumir que vagas foram criadas
            totalVagas = 1;
          } else if (result.message && result.message.includes('criada')) {
            // Se a mensagem indica que vagas foram criadas
            totalVagas = 1;
          } else if (result.success === true || result.status === 'success') {
            // Se a resposta indica sucesso, assumir que vagas foram criadas
            totalVagas = 1;
          }
          
          console.log('📋 Total de vagas detectadas:', totalVagas);
          console.log('📋 Estrutura do resultado:', Object.keys(result));
          console.log('📋 Mensagem da API:', result.message || 'N/A');
          console.log('📋 Status da API:', result.status || result.success || 'N/A');
          
          if (totalVagas > 0 || result.success === true || result.status === 'success' || (result.message && result.message.toLowerCase().includes('criada'))) {
            let mensagem = `🎉 Sucesso! Vagas criadas para ${dataInicio}`;
            
            if (totalVagas > 0) {
              mensagem = `🎉 Sucesso! ${totalVagas} vagas criadas para ${dataInicio}`;
            }
            
            // Adicionar detalhes das vagas se disponível
            if (vagasCriadas.length > 0) {
              mensagem += '\n\nVagas criadas:';
              vagasCriadas.forEach((vaga, index) => {
                mensagem += `\n${index + 1}. ID: ${vaga.id || 'N/A'} | Status: ${vaga.status || 'N/A'}`;
              });
            }
            
            // Adicionar mensagem da API se disponível
            if (result.mensagem) {
              mensagem += `\n\n📋 ${result.mensagem}`;
            } else if (result.message) {
              mensagem += `\n\n📋 ${result.message}`;
            }
            
            // Adicionar detalhes dos estabelecimentos se disponível
            if (result.estabelecimentos_processados && Array.isArray(result.estabelecimentos_processados)) {
              mensagem += `\n\n🏢 Estabelecimentos processados:`;
              result.estabelecimentos_processados.forEach((est, index) => {
                mensagem += `\n${index + 1}. ${est.estabelecimento} - ${est.vagas_criadas} vagas criadas`;
              });
            }
            
            alert(mensagem);
          } else {
            let mensagem = `⚠️ Nenhuma vaga foi criada para ${dataInicio}\n\n`;
            mensagem += `📋 Resposta da API:\n${JSON.stringify(result, null, 2)}\n\n`;
            mensagem += `❓ Possíveis motivos:\n`;
            mensagem += `• Vagas já existem para esta data\n`;
            mensagem += `• Estabelecimento não configurado\n`;
            mensagem += `• Configuração inválida\n`;
            mensagem += `• Problemas na API`;
            
            alert(mensagem);
          }
          
        } else {
          const errorText = await response.text();
          console.error('❌ Erro da API:', errorText);
          alert(`❌ Erro ao gerar vagas:\n\n${errorText}`);
        }

      } catch (error) {
        console.error('❌ Erro:', error);
        alert(`❌ Erro: ${error.message}`);
      }
    }
    
    // Função para carregar lista de vagas
    async function carregarListaVagas() {
      const detailElement = document.getElementById("detail");
      if (!detailElement) return;
      
      try {
        // Verificar se está autenticado
        if (!window.authManager || !window.authManager.isAuthenticated) {
          detailElement.innerHTML = `
            <div class="empty">
              <div style="text-align: center; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 10px;">🔐</div>
                <div>Faça login para visualizar as vagas</div>
              </div>
            </div>
          `;
          return;
        }
        
        // Interface de carregamento
        detailElement.innerHTML = `
          <div class="hdr">
            <div class="title"><strong>📋 Lista de Vagas</strong></div>
            <div class="meta">
              <span class="pill">Filtrar por período</span>
            </div>
          </div>
          
          <div class="search-row" style="margin-bottom: 16px;">
            <select id="filtroPeriodo" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
              <option value="7">Últimos 7 dias</option>
              <option value="15">Últimos 15 dias</option>
              <option value="30">Últimos 30 dias</option>
              <option value="90">Últimos 90 dias</option>
              <option value="todos">Todas as vagas</option>
            </select>
            <button onclick="carregarListaVagas()" class="btn" style="margin-left: 8px;">🔄</button>
          </div>
          
          <div id="vagasLista" style="text-align: center; padding: 20px;">
            <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
            <div>Carregando vagas...</div>
          </div>
        `;
        
        // Buscar vagas da API
        const filtroPeriodo = document.getElementById("filtroPeriodo")?.value || "7";
        const response = await window.authManager.authenticatedRequest('/vagas/', {
          method: 'GET'
        });
        
        if (response.ok) {
          const vagas = await response.json();
          console.log('📋 Vagas carregadas:', vagas);
          
          // Filtrar vagas por período se necessário
          let vagasFiltradas = vagas;
          if (filtroPeriodo !== "todos") {
            const diasAtras = parseInt(filtroPeriodo);
            const dataLimite = new Date();
            dataLimite.setDate(dataLimite.getDate() - diasAtras);
            
            vagasFiltradas = vagas.filter(vaga => {
              const dataVaga = new Date(vaga.data_da_vaga);
              return dataVaga >= dataLimite;
            });
          }
          
          // Renderizar lista de vagas
          renderizarListaVagas(vagasFiltradas);
          
        } else {
          const errorText = await response.text();
          console.error('❌ Erro ao carregar vagas:', errorText);
          document.getElementById("vagasLista").innerHTML = `
            <div style="text-align: center; padding: 20px; color: #e74c3c;">
              <div style="font-size: 24px; margin-bottom: 10px;">❌</div>
              <div>Erro ao carregar vagas</div>
              <div style="font-size: 12px; margin-top: 10px;">${errorText}</div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('❌ Erro ao carregar vagas:', error);
        document.getElementById("vagasLista").innerHTML = `
          <div style="text-align: center; padding: 20px; color: #e74c3c;">
            <div style="font-size: 24px; margin-bottom: 10px;">❌</div>
            <div>Erro ao carregar vagas</div>
            <div style="font-size: 12px; margin-top: 10px;">${error.message}</div>
          </div>
        `;
      }
    }
    
    // Função para renderizar lista de vagas
    function renderizarListaVagas(vagas) {
      const vagasListaElement = document.getElementById("vagasLista");
      if (!vagasListaElement) return;
      
      if (!vagas || vagas.length === 0) {
        vagasListaElement.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #7f8c8d;">
            <div style="font-size: 24px; margin-bottom: 10px;">📭</div>
            <div>Nenhuma vaga encontrada</div>
          </div>
        `;
        return;
      }
      
      // Ordenar vagas por data (mais recentes primeiro)
      vagas.sort((a, b) => new Date(b.data_da_vaga) - new Date(a.data_da_vaga));
      
      let html = `
        <div style="max-height: 600px; overflow-y: auto;">
          <div style="font-size: 12px; color: #666; margin-bottom: 10px; text-align: center;">
            ${vagas.length} vagas encontradas
          </div>
      `;
      
      vagas.forEach((vaga, index) => {
        const dataFormatada = new Date(vaga.data_da_vaga).toLocaleDateString('pt-BR');
        const statusClass = vaga.status === 'aberta' ? 'chip-success' : vaga.status === 'encerrada' ? 'chip-warning' : 'chip-ghost';
        
        html += `
          <div class="card" style="margin-bottom: 12px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 600; font-size: 14px;">Vaga #${vaga.id}</div>
              <span class="chip ${statusClass}" style="font-size: 11px;">${vaga.status}</span>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
              📅 ${dataFormatada} • 🏢 ${vaga.estabelecimento_nome || 'N/A'}
            </div>
            
            <div style="font-size: 12px; color: #666;">
              📋 ${vaga.tipo_vaga || 'N/A'} • 🕐 ${vaga.hora_inicio_padrao || 'N/A'} - ${vaga.hora_fim_padrao || 'N/A'}
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
      vagasListaElement.innerHTML = html;
    }
  </script>

  <!-- Navegação entre views (inclui Admin Vagas) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const views = {
        orders: document.getElementById("left-orders"),
        vagas:  document.getElementById("left-vagas"),
        alocacoes: document.getElementById("left-alocacoes"),
        adminV: document.getElementById("left-admin-vagas"),
      };
      const buttons = {
        orders: document.getElementById("btn-orders"),
        vagas:  document.getElementById("btn-vagas"),
        alocacoes: document.getElementById("btn-alocacoes"),
        adminV: document.getElementById("btn-admin-vagas"),
      };

      function showView(name){
        Object.values(views).forEach(v=>v.classList.add("hidden"));
        views[name].classList.remove("hidden");
        Object.values(buttons).forEach(b=>b.classList.remove("active"));
        buttons[name].classList.add("active");
      }

      buttons.orders.addEventListener("click",()=>{
        showView("orders");
        const d=document.getElementById("detail");
        d.classList.add("empty");
        d.textContent="Selecione um pedido para ver detalhes";
      });



      buttons.vagas.addEventListener("click", async () => {
        showView("vagas");
        
        // Carregar vagas usando nossa integração
        try {
          if (typeof window.renderVagasInSidebar === 'function') {
            await window.renderVagasInSidebar();
          } else {
            console.warn('⚠️ Módulo de integração de vagas não carregado');
          }
        } catch (error) {
          console.error('❌ Erro ao carregar vagas:', error);
        }
        
        const d=document.getElementById("detail");
        d.classList.add("empty");
        d.textContent="Selecione uma vaga para ver detalhes";
      });

      buttons.alocacoes.addEventListener("click", async () => {
        showView("alocacoes");
        
        // Carregar alocações usando nossa integração
        try {
          if (typeof window.renderAlocacoes === 'function') {
            await window.renderAlocacoes();
          } else {
            console.warn('⚠️ Módulo de integração de alocações não carregado');
          }
        } catch (error) {
          console.error('❌ Erro ao carregar alocações:', error);
        }
        
        const d=document.getElementById("detail");
        d.classList.add("empty");
        d.textContent="Selecione uma alocação para ver detalhes";
      });

      buttons.adminV.addEventListener("click", async ()=>{
        showView("adminV");
        if (window.adminVagas && typeof adminVagas.init==="function") {
          adminVagas.init();
        }
        
        // Definir data atual como padrão
        const dataInicioInput = document.getElementById("dataInicioVagas");
        if (dataInicioInput) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          dataInicioInput.value = `${year}-${month}-${day}`;
        }
        
        // Carregar lista de vagas no painel direito
        await carregarListaVagas();
      });
    });
  </script>

</body>
</html>